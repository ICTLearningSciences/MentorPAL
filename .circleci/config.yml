version: 2.1
executors:
  ebs:
    docker:
      - image: larrykirschner/circleci-elasticbeanstalk:1.1.0
  node:
    docker:
      - image: circleci/node:12.4
  python:
    docker:
      - image: circleci/python:3.6.9
aliases:
  # setup env vars for ebs tools
  - &dev-mentorpal-env-init
    name: dev-mentorpal env init
    command: eval $EBS_TOOLS_ENV_INIT && echo 'export EB_ENV=dev-mentorpal' >> $BASH_ENV
  - &qa-mentorpal-env-init
    name: qa-mentorpal env init
    command: eval $EBS_TOOLS_ENV_INIT && echo 'export EB_ENV=qa-mentorpal' >> $BASH_ENV
  - &prod-mentorpal-env-init
    name: qa-mentorpal env init
    command: eval $EBS_TOOLS_ENV_INIT && echo 'export EB_ENV=prod-mentorpal' >> $BASH_ENV
  - &eb-deploy
    name: EBS Deploy
    # TODO: now hardcoded with arch 'lstm_v1' and --newest. 
    # This should be made configurable but in a way that is minimally burdonsome/error prone
    command: |
      cd ${EBS_TOOLS} \
        && make clean build \
        && mkdir -p build/ebs/bundle/mentor-api/checkpoint \
        && pip install --user -e git+https://github.com/ICTLearningSciences/mentor-classifier.git@1.0.0#egg=mentor_classifier \
        && mentor_classifier_copy_models \
          --newest \
          --arch lstm_v1 \
          --from ~/project/checkpoint/classifiers \
          --to build/ebs/bundle/mentor-api/checkpoint/classifiers \
        && cp -r ~/project/checkpoint/vector_models build/ebs/bundle/mentor-api/checkpoint/vector_models \
        && cp -r ~/project/mentors/data/mentors build/ebs/bundle/mentor-api/mentors \
        && make eb-deploy
  - &only-master
    branches:
      only:
        - master
  - &only-prod-releases
    tags:
      only: /v[0-9]+(\.[0-9]+)*(-prod)/
    branches:
      ignore: /.*/
  - &git-lfs-install
    run:
      name: Git lfs install
      command: |
        curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash \
          && sudo apt-get install -y git-lfs \
          && git lfs install
  - &git-lfs-pull
    run:
      name: Git lfs pull
      command: git lfs pull
  - &checkout-revision-restore
    restore_cache:
      keys:
        - source-v1-{{ .Branch }}-{{ .Revision }}
        - source-v1-{{ .Branch }}-
        - source-v1-
  - &checkout-revision-save
    save_cache:
      key: source-v1-{{ .Branch }}-{{ .Revision }}
      paths:
        - ".git"
jobs:
  checkout-revision-setup:
    executor: python
    steps:
      - *checkout-revision-restore
      - *git-lfs-install
      - checkout
      - *git-lfs-pull
      - *checkout-revision-save
  test-format:
    executor: python
    steps:
      - *checkout-revision-restore
      - *git-lfs-install
      - checkout
      - run:
          name: Test format
          command: make test-format-python
  test-lint:
    executor: python
    steps:
      - *checkout-revision-restore
      - *git-lfs-install
      - checkout
      - run:
          name: Test lint
          command: make lint-python
  mentor-pipeline-test:
    executor: python
    steps:
      - *checkout-revision-restore
      - *git-lfs-install
      - checkout
      - run:
          name: Test mentor pipeline
          command: cd mentors && make test
  reports-test:
    executor: node
    steps:
      - *checkout-revision-restore
      - *git-lfs-install
      - checkout
      - run:
          name: Test reports
          command: |
            cd reports \
            && npm install \
            && npm test
  dev-ebs-deploy:
    executor: ebs
    steps:
      - *git-lfs-install
      - checkout
      - *git-lfs-pull
      - run: *dev-mentorpal-env-init
      - run: *eb-deploy
  qa-ebs-deploy:
    executor: ebs
    steps:
      - *git-lfs-install
      - checkout
      - *git-lfs-pull
      - run: *qa-mentorpal-env-init
      - run: *eb-deploy
  prod-ebs-deploy:
    executor: ebs
    steps:
      - *git-lfs-install
      - checkout
      - *git-lfs-pull
      - run: *prod-mentorpal-env-init
      - run: *eb-deploy
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - checkout-revision-setup
      - test-format:
          requires:
            - checkout-revision-setup
      - test-lint:
          requires:
            - checkout-revision-setup
      - mentor-pipeline-test:
          requires:
            - format-and-lint-python
      - reports-test:
          requires:
            - format-and-lint-python
      - deploy-to-dev:
          type: approval
          requires:
            - test-format
            - test-lint
            - mentor-pipeline-test
            - reports-test
      - dev-ebs-deploy:
          requires:
            - deploy-to-dev
      - qa-ebs-deploy:
          filters: *only-master
          requires:
            - test-format
            - test-lint
            - mentor-pipeline-test
            - reports-test
  build-test-deploy-prod:
    jobs:
      - prod-ebs-deploy:
          filters: *only-prod-releases
          requires:
            - prod-docker-build-test-push
